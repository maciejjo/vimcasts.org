<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Use title if it's in the page YAML frontmatter -->
    <title></title>

    
      <meta name="st:robots" content="follow, index">
    

    <link href="/stylesheets/app.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/modernizr.js" type="text/javascript"></script>
  </head>

  <body class="episodes episodes_64 episodes_64_transcript episodes_64_transcript_index" data-swiftype-index='false'>

  <div class="off-canvas-wrap">
    <div class="inner-wrap">

      <div class="top-bar-underlay"></div>

      <div class="row">
        <nav class="top-bar show-for-large-up" data-topbar>
          <ul class="title-area">
            <li class="name">
              <h1><a href="/">Vimcasts</a></h1>
            </li>
            <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
          </ul>

          <section class="top-bar-section">

            
              <!-- Right Nav Section -->
              <ul class="right">
                <li class="has-form">
                <div class="row collapse">
                  <div class="large-12 columns">
                    <form class="swiftype-search-form"><input type="search" placeholder="Search the archives"/></form>


                  </div>
                </div>
                </li>
              </ul>
            

            <!-- Left Nav Section -->
            <ul class="left">
              <li class="has-dropdown">
  <a href="/categories">Browse Vimcasts</a>
  <ul class="dropdown">
    <li><a href="/episodes">Latest episodes</a></li>
    <li><a href="/blog">Latest articles</a></li>
  </ul>
</li>
<li><a href="/training">Training</a></li>
<li><a href="/publications">Publications</a></li>


            </ul>
          </section>
        </nav>
      </div>

      <nav class="tab-bar hide-for-large-up">
        <section class="left-small">
          <a class="left-off-canvas-toggle menu-icon" ><span></span></a>
        </section>

        <section class="middle tab-bar-section"></section>
      </nav>

      <aside class="left-off-canvas-menu">
        <ul class="off-canvas-list">
          <li><label>Vimcasts</label></li>
          <li class="has-dropdown">
  <a href="/categories">Browse Vimcasts</a>
  <ul class="dropdown">
    <li><a href="/episodes">Latest episodes</a></li>
    <li><a href="/blog">Latest articles</a></li>
  </ul>
</li>
<li><a href="/training">Training</a></li>
<li><a href="/publications">Publications</a></li>



          
            <li>
              <form class="swiftype-search-form"><input type="search" placeholder="Search the archives"/></form>


            </li>
          
        </ul>
      </aside>

      <section class="main-section">

        <div class="row identity-row">
          <div id="logo" class="small-4 columns">
            <h1>
              
                <a href="/" title="Go to Vimcasts.org homepage">VimCasts.org</a>
              
            </h1>
          </div>
          <div class="small-7 small-offset-1 columns">
            
            <h4 class="text-right">
              Level-up your Vim<br/>
              <small>with Drew Neil, author of <a href="http://pragprog.com/book/dnvim/practical-vim">Practical&nbsp;Vim</a></small>
            </h4>
            
          </div>
        </div>

        <p>Here I've got an HTML document that contains some crufty markup.
This source code was generated by a WYSIWYG editor and I'd like to clean it up.
I recently saw a neat trick on Twitter from Stephen Hay, who says that:</p>

<blockquote>
  <p>Few things clean up CMS-input HTML better than running it through Pandoc to convert to Markdown and then back to HTML again. 1 sec, big win.</p>
</blockquote>

<p>In case you don't know, pandoc is a swiss-army knife for converting between all sorts of markup formats.
I'll demonstrate first at the command line, then we'll look at how to integrate this tool with our Vim setup.</p>

<p>We can pipe the contents of this file into pandoc, instructing it to convert from html to markdown:</p>

<pre><code>cat tea-dance.tinymce.html | pandoc --from=html --to=markdown
</code></pre>

<p>We can see the results on standard out: it's the same content, but now in markdown format. We could then pipe this document back into pandoc, and ask it to convert from markdown back to html:</p>

<pre><code>cat tea-dance.tinymce.html | pandoc --from=html --to=markdown | pandoc --from=markdown --to=html
</code></pre>

<p>That gives us the same content in HTML, minus all of the crufty markup that the WYSIWYG editor generated.
Pretty neat!</p>

<h3 id="using-filter-commands-in-vim">Using filter commands in Vim</h3>

<p>In this example, we're using pandoc as a <em>filter</em>.</p>

<pre><code>:h filter
</code></pre>

<p>That is: a program "that accepts text at standard input, changes it in some way, and sends it to standard output".</p>

<pre><code>:h :!
</code></pre>

<p>The bang Ex command lets us send a range of lines from our current buffer to an external filter program. The the original text from the buffer will be replaced by the output from the external command.</p>

<p>Let's try that out (I've saved the pandoc command in register 'a', so I'll just paste it):</p>

<pre><code>:%!pandoc -f html -t markdown | pandoc -f markdown -t html
</code></pre>

<p>Boom! The entire buffer has been overwritten with the output from our pandoc pipeline.</p>

<p>In a followup tweet, Stephen suggests mapping this Ex command to a key so we can run it more easily.
For example, you could add a mapping for normal mode and another for visual mode:</p>

<pre><code>nnoremap &lt;leader&gt;gq :%!pandoc -f html -t markdown | pandoc -f markdown -t html&lt;CR&gt;
vnoremap &lt;leader&gt;gq :!pandoc -f html -t markdown | pandoc -f markdown -t html&lt;CR&gt;
</code></pre>

<p>That'll work, but I want to suggest a way of doing it without leader mappings.</p>

<pre><code>:h formatprg
</code></pre>

<p>The <code>formatprg</code> option lets us specify an external program that will be triggered by the <code>gq</code> operator.
In episode 18 of Vimcasts, I demonstrated how the external <code>par</code> command could be used for the task of formatting plain text files with hard-wrapping.
We could use a similar technique here.</p>

<p>Let's set the <code>formatprg</code> option to our pandoc pipeline:</p>

<pre><code>let &amp;formatprg="pandoc --from=html --to=markdown | pandoc --from=markdown --to=html"
</code></pre>

<p>Now when we use the <code>gq</code> command, Vim passes the selected text to pandoc for processing.</p>

<p>That means I can operate on the current line by pressing <code>gqq</code>.
Or I can filter the entire buffer through pandoc by pressing <code>gqG</code> "gee-queue-shift-gee".
Or I can switch to visual mode, and <code>gq</code> filters the selected lines only.</p>

<p>If you like this approach, I would recommend using this autocommand:</p>

<pre><code>if has("autocmd")
  let pandoc_pipeline  = "pandoc --from=html --to=markdown"
  let pandoc_pipeline .= " | pandoc --from=markdown --to=html"
  autocmd FileType html let &amp;formatprg=pandoc_pipeline
endif
</code></pre>

<p>Which sets up pandoc as the formatprg for HTML files only. If you can think of other filter commands that could be used in this fashion, you can always use this autocommand as a template.</p>


      </section>

      <a class="exit-off-canvas"></a>

    </div>
  </div>

    <script type="text/javascript">
var Swiftype = window.Swiftype || {};
  (function() {
    Swiftype.key = 'Wdx4LxrBJv86q28yDA8A';
    Swiftype.renderStyle = 'new_page';
    Swiftype.resultPageURL = '/results/index.html';

    /** DO NOT EDIT BELOW THIS LINE **/
    var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
    script.src = "//s.swiftypecdn.com/embed.js";
    var entry = document.getElementsByTagName('script')[0];
    entry.parentNode.insertBefore(script, entry);
  }());
</script>

    <script src="/javascripts/all.js" type="text/javascript"></script>
  </body>
</html>
