
<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Using external filter commands to reformat HTML</title>

    
      <meta name="st:robots" content="follow, index">
    

    
      <link href="/feeds/ogg" title="Vimcasts OGG Feed" rel="alternate" type="application/rss+xml" />
    
      <link href="/feeds/quicktime" title="Vimcasts Quicktime Feed" rel="alternate" type="application/rss+xml" />
    

    <link href="/stylesheets/app.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/autocomplete.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/modernizr.js" type="text/javascript"></script>
  </head>

  <body class="episodes episodes_using-external-filter-commands-to-reformat-html episodes_using-external-filter-commands-to-reformat-html_index" data-swiftype-index='false'>

  <div class="off-canvas-wrap">
    <div class="inner-wrap">

      <div class="top-bar-underlay"></div>

      <div class="row">
        <nav class="top-bar show-for-large-up" data-topbar>
          <ul class="title-area">
            <li class="name">
              <h1><a href="/">Vimcasts</a></h1>
            </li>
            <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
          </ul>

          <section class="top-bar-section">

            
              <!-- Right Nav Section -->
              <ul class="right">
                <li class="has-form">
                <div class="row collapse">
                  <div class="large-12 columns">
                    <form class="swiftype-search-form">
  <input type="search" class="swiftype-search-input" placeholder="Search the archives"/>
</form>


                  </div>
                </div>
                </li>
              </ul>
            

            <!-- Left Nav Section -->
            <ul class="left">
              <li class="has-dropdown">
  <a href="/categories">Browse Vimcasts</a>
  <ul class="dropdown">
    <li><a href="/episodes">Latest episodes</a></li>
    <li><a href="/blog">Latest articles</a></li>
  </ul>
</li>
<li><a href="/training">Training</a></li>
<li><a href="/publications">Publications</a></li>


            </ul>
          </section>
        </nav>
      </div>

      <nav class="tab-bar hide-for-large-up">
        <section class="left-small">
          <a class="left-off-canvas-toggle menu-icon" ><span></span></a>
        </section>

        <section class="middle tab-bar-section"></section>
      </nav>

      <aside class="left-off-canvas-menu">
        <ul class="off-canvas-list">
          <li><label>Vimcasts</label></li>
          <li class="has-dropdown">
  <a href="/categories">Browse Vimcasts</a>
  <ul class="dropdown">
    <li><a href="/episodes">Latest episodes</a></li>
    <li><a href="/blog">Latest articles</a></li>
  </ul>
</li>
<li><a href="/training">Training</a></li>
<li><a href="/publications">Publications</a></li>



          
            <li>
              <form class="swiftype-search-form">
  <input type="search" class="swiftype-search-input" placeholder="Search the archives"/>
</form>


            </li>
          
        </ul>
      </aside>

      <section class="main-section">

        <div class="row identity-row">
          <div id="logo" class="small-4 columns">
            <h1>
              
                <a href="/" title="Go to Vimcasts.org homepage">VimCasts.org</a>
              
            </h1>
          </div>
          <div class="small-7 small-offset-1 columns">
            
            <h4 class="text-right">
              Level-up your Vim<br/>
              <small>with Drew Neil, author of <a href="http://pragprog.com/book/dnvim/practical-vim">Practical&nbsp;Vim</a></small>
            </h4>
            
          </div>
        </div>

          <div class="row">
    <div class="small-12 columns">

      

<div class="row announcement-banner">
  <div class="small-12 column show-for-small-only">
    <div class="panel">
      <p>
            No Core Vim Classes are currently scheduled. <a href="#">Sign up to the mailing list</a> to hear of upcoming classes.
</p>

      
    </div>
  </div>

  <div class="panel show-for-medium-up clearfix">
    <div class="small-8 column">
      <p>
            No Core Vim Classes are currently scheduled. <a href="#">Sign up to the mailing list</a> to hear of upcoming classes.
</p>

    </div>

    <div class="small-4 column">
      
    </div>
  </div>

</div>



      <header>
        <h2>Using external filter commands to reformat HTML</h2>
        <div class="episode_number">
          <small>#</small>64
        </div>
        <time pubdate="pubdate" datetime="2014-02-18">
          Feb 18, 2014
        </time>
        <div class="video-duration">
          
          Run time: <time datetime="P4M,31S">
            4:31
          </time>
        </div>
        
          <div class="video-tags">
            Tagged with:
            <a href="/categories/html">html</a>, <a href="/categories/external-filters">external-filters</a>
          </div>
        
      </header>

      <div data-swiftype-index="true">
        <p>We can use pandoc as a <a href="http://vimdoc.sourceforge.net/htmldoc/change.html#filter">filter</a> to clean up <abbr title="what you see is what you get">WYSIWYG</abbr>-generated HTML. Pandoc is a commandline program, but we can call it from inside Vim either using the <a href="http://vimdoc.sourceforge.net/htmldoc/various.html#:!">bang Ex command</a>, or by configuring <a href="http://vimdoc.sourceforge.net/htmldoc/options.html#&amp;#x27;formatprg&amp;#x27;">the <code>formatprg</code> option</a> to make the <code>gq</code> operator invoke pandoc.</p>


      </div>

      <video poster="http://vimcasts.org/images/posters/formatprg-pandoc.png"
        controls="controls" preload="none" class="placeholder"
        id="episode_64_placeholder">
        <source src="http://media.vimcasts.org/videos/64/pandoc-filter.ogv" type="video/ogg" />
        <source src="http://media.vimcasts.org/videos/64/pandoc-filter.m4v" type="video/x-m4v" />
      </video>

      <aside class="downloads">
        <ul class="inline-list">
          <li>Download: </li>

          <li class="ogg">
          <a href="http://media.vimcasts.org/videos/64/pandoc-filter.ogv">OGG</a>
          <span class="stats">8.9 MB</span>
          </li>

          <li class="quicktime">
          <a href="http://media.vimcasts.org/videos/64/pandoc-filter.m4v">Quicktime</a>
          <span class="stats">16.3 MB</span>
          </li>

      </ul>

        <p>
          View a <a href="/transcripts/64/en/">transcript of the video</a>.
        </p>
      </aside>

      <dl class="accordion" data-accordion>
        <dd>
        <a href="#shownotes">Shownotes</a>
        <div id="shownotes" class="content" data-swiftype-index="true">
          

<p>I recently saw <a href="https://twitter.com/stephenhay/status/413659466211397633">a neat trick</a> on Twitter from Stephen Hay, who says that:</p>

<blockquote>
<p>Few things clean up CMS-input HTML better than running it through Pandoc to convert to Markdown and then back to HTML again. 1 sec, big win.</p>
</blockquote>

<p><a href="http://johnmacfarlane.net/pandoc/">pandoc</a> is a swiss-army knife for converting between all sorts of markup formats. You can find <a href="http://johnmacfarlane.net/pandoc/installing.html">installation instructions on the pandoc site</a>.</p>

<p>Suppose we have a <code>tea-dance.html</code> file that contains crufty markup, because it was generated by a <abbr title="what you see is what you get">WYSIWYG</abbr> editor. We could clean it up by running this at the command line:</p>
<pre class="highlight plaintext">cat tea-dance.html | pandoc --from=html --to=markdown | pandoc --from=markdown --to=html
</pre>

<p>This emits a cleaned up version of <code>tea-dance.html</code> on standard out.</p>

<p>We&rsquo;re using pandoc as a <a href="http://vimdoc.sourceforge.net/htmldoc/change.html#filter">filter</a>, that is: a program &ldquo;that accepts text at standard input, changes it in some way, and sends it to standard output&rdquo;.</p>

<h3>Running text from a Vim buffer through an external filter</h3>

<p>Suppose that we open the <code>tea-dance.html</code> file in Vim. We can use the <a href="http://vimdoc.sourceforge.net/htmldoc/various.html#:!">bang Ex command</a> to filter the contents of the current buffer through our pandoc pipeline:</p>
<pre class="highlight plaintext">:%!pandoc --from=html --to=markdown | pandoc --from=markdown --to=html
</pre>

<p>Vim will take the output from that pipeline and use it to overwrite the original text from the buffer.</p>

<p>In a <a href="https://twitter.com/stephenhay/status/413668124051775488">followup tweet</a>, Stephen suggests mapping this Ex command to a key so we can run it more easily.
For example, you could add a mapping for normal mode and another for visual mode:</p>
<pre class="highlight viml">nnoremap <span class="p">&lt;</span>leader<span class="p">&gt;</span>gq <span class="p">:</span>%<span class="p">!</span>pandoc <span class="p">-</span><span class="k">f</span> html <span class="p">-</span><span class="k">t</span> markdown <span class="p">|</span> pandoc <span class="p">-</span><span class="k">f</span> markdown <span class="p">-</span><span class="k">t</span> html<span class="p">&lt;</span>CR<span class="p">&gt;</span>
vnoremap <span class="p">&lt;</span>leader<span class="p">&gt;</span>gq <span class="p">:!</span>pandoc <span class="p">-</span><span class="k">f</span> html <span class="p">-</span><span class="k">t</span> markdown <span class="p">|</span> pandoc <span class="p">-</span><span class="k">f</span> markdown <span class="p">-</span><span class="k">t</span> html<span class="p">&lt;</span>CR<span class="p">&gt;</span>
</pre>

<p>That&rsquo;ll work, but I want to suggest a way of doing it <a href="http://vimcasts.org/blog/2014/02/follow-my-leader/">without leader mappings</a>.</p>

<h3>Set up formatprg to filter selection through pandoc</h3>

<p>In <a href="/e/18">episode 18</a> of Vimcasts, I demonstrated how the external <code>par</code> command could be used for the task of formatting plain text files with hard-wrapping.
We could use a similar technique here.</p>

<p>The <a href="http://vimdoc.sourceforge.net/htmldoc/change.html#gq"><code>gq</code></a> operation runs the selected text through the filter specified by <a href="http://vimdoc.sourceforge.net/htmldoc/options.html#&amp;#x27;formatprg&amp;#x27;"><code>formatprg</code></a>.
This autocommand sets <code>formatprg</code> for HTML files to use our pandoc pipeline:</p>
<pre class="highlight viml"><span class="k">if</span> has<span class="p">(</span><span class="s2">"autocmd"</span><span class="p">)</span>
  <span class="k">let</span> pandoc_pipeline  <span class="p">=</span> <span class="s2">"pandoc --from=html --to=markdown"</span>
  <span class="k">let</span> pandoc_pipeline <span class="p">.=</span> <span class="s2">" | pandoc --from=markdown --to=html"</span>
  autocmd <span class="nb">FileType</span> html <span class="k">let</span> &amp;formatprg<span class="p">=</span>pandoc_pipeline
<span class="k">endif</span>
</pre>

<p>That means we can filter the current line through pandoc by pressing <code>gqq</code>.
Or we can filter the entire buffer by pressing <code>gg</code> then <code>gqG</code>.
Or we can switch to visual mode, and <code>gq</code> will filter only the selected lines.</p>

<h3 id='update'>Update: use `formatexpr` instead</h3>

<p>As domo pointed out in the comments, the <code>formatprg</code> setting can only be set globally. That&rsquo;s unfortunate! <a href="https://twitter.com/kana1/status/435717948435484672">Kana suggested using <code>formatexpr</code> instead</a>, so I came up with this alternative:</p>
<pre class="highlight viml"><span class="k">function</span><span class="p">!</span> FormatprgLocal<span class="p">(</span>filter<span class="p">)</span>
<span class="k">if</span> <span class="p">!</span>empty<span class="p">(</span><span class="k">v</span><span class="p">:</span>char<span class="p">)</span>
  <span class="k">return</span> <span class="m">1</span>
<span class="k">else</span>
  <span class="k">let</span> <span class="k">l</span><span class="p">:</span>command <span class="p">=</span> <span class="k">v</span><span class="p">:</span>lnum<span class="p">.</span><span class="s1">','</span><span class="p">.(</span><span class="k">v</span><span class="p">:</span>lnum<span class="p">+</span><span class="k">v</span><span class="p">:</span><span class="k">count</span><span class="m">-1</span><span class="p">).</span><span class="s1">'!'</span><span class="p">.</span><span class="nv">a:filter</span>
  echo <span class="k">l</span><span class="p">:</span>command
  execute <span class="k">l</span><span class="p">:</span>command
<span class="k">endif</span>
<span class="k">endfunction</span>

<span class="k">if</span> has<span class="p">(</span><span class="s2">"autocmd"</span><span class="p">)</span>
  <span class="k">let</span> pandoc_pipeline  <span class="p">=</span> <span class="s2">"pandoc --from=html --to=markdown"</span>
  <span class="k">let</span> pandoc_pipeline <span class="p">.=</span> <span class="s2">" | pandoc --from=markdown --to=html"</span>
  autocmd <span class="nb">FileType</span> html <span class="k">setlocal</span> formatexpr<span class="p">=</span>FormatprgLocal<span class="p">(</span>pandoc_pipeline<span class="p">)</span>
<span class="k">endif</span>
</pre>

<p>However, this approach has a setback of its own. According to Sung Pae in the discussion for <a href="https://groups.google.com/forum/#!msg/vim_dev/cFK1UjstyAk/mreb2H4VCtoJ">this patch to convert formatprg to a global-local option</a>:</p>

<blockquote>
<p>formatexpr<code>is called on every keystroke in Insert mode, even when
</code>formatoptions<code>is empty. This suggests to me that the primary purpose of
</code>formatexpr<code>is for fine-grained control over automatic formatting, rather
than to be a simple, on demand paragraph formatter like</code>fmt<code>or</code>par`</p>
</blockquote>

<p>Sung Pae&rsquo;s patch makes <code>formatprg</code> global-local, which means that it could be configured independently for differnt filetypes. It would be great if that patch could be folded into core Vim!</p>

<h3>Further reading</h3>

<ul>
<li>Stephen Hay&rsquo;s tweets: <a href="https://twitter.com/stephenhay/status/413659466211397633">one</a> and <a href="https://twitter.com/stephenhay/status/413668124051775488">two</a></li>
<li><a href="http://johnmacfarlane.net/pandoc/">pandoc</a></li>
<li><a href="http://johnmacfarlane.net/pandoc/installing.html">Installing pandoc</a></li>
<li><a href="http://vimdoc.sourceforge.net/htmldoc/change.html#filter"><code>:h filter</code></a></li>
<li><a href="http://vimdoc.sourceforge.net/htmldoc/various.html#:!"><code>:h :range!</code></a></li>
<li><a href="http://vimdoc.sourceforge.net/htmldoc/options.html#&amp;#x27;formatprg&amp;#x27;"><code>:h formatprg</code></a></li>
<li><a href="http://vimdoc.sourceforge.net/htmldoc/change.html#gq"><code>:h gq</code></a></li>
</ul>

        </div>
        </dd>
        <dd>
        <a href="#comments">Comments</a>
        <div id="comments" class="content">
          <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'vimcasts'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


        </div>
        </dd>
      </dl>

      <div>
        <p>
        Like this video? Spread the word!
        TODO: add social sharing buttons here.
        </p>
      </div>


      <div>
  <hr/>
  <h3>Related content</h3>
  <ul class="small-block-grid-1 medium-block-grid-2 large-block-grid-3">

    
    

    
      <li>
        <h4><a href="/episodes/swapping-two-regions-of-text-with-exchange-vim/">Swapping two regions of text with exchange.vim</a></h4>
        <p>Swapping two regions of text is a common task, which normally requires that we make two separate changes to the document.
Tom McDonald&rsquo;s <a href="https://github.com/tommcdo/vim-exchange">exchange plugin</a> offers an elegant alternative, by providing an operator that swaps two regions of text in one go.</p>


      </li>
    
      <li>
        <h4><a href="/training">Vim Training</a></h4>
        <p>Boost your productivity with a <a href='/training'>Vim training class</a>. Join a public class, or <a href='/training/private'>book a private session</a> for your team.</p>
      </li>
    
      <li>
        <h4><a href="/blog/2014/02/vimcasts-redesign-a-work-in-progress/">Vimcasts redesign: a work in progress</a></h4>
        <p>In the not-too-distant future, you can expect to see a revised design for Vimcasts.org. The most significant enhancements will be the addition of tags, site search, and a responsive design for smaller screens. Hannah Adcock, from <a href="http://contentedstrategy.com">contentedstrategy.com</a>, has been helping me out by analysing user feedback, as well as data from Google Analytics.</p>


      </li>
    
      <li>
        <h4><a href="/categories">Find by category</a></h4>
        <p>Vimcasts contains 65 free screencasts and 45 articles. <a href='/categories'>Browse all content by category</a>.</p>
      </li>
    
      <li>
        <h4><a href="/publications">Publications</a></h4>
        <p>Make yourself a faster and more efficient developer with the help of <a href='/publications'>these publications</a>.</p>
      </li>
    
      <li>
        <h4><a href="/episodes/formatting-text-with-par/">Formatting text with par</a></h4>
        <p>&lsquo;Do one thing and do it well&rsquo; is the principle of the Unix toolkit. Editing text is a broad domain, and there are many related tasks with which it overlaps. Vim acknowledges this by enabling certain tasks to be outsourced to external programs which do that one thing, and do it well. This episode will demonstrate how the <em>par</em> program can be used for formatting text.</p>


      </li>
    

  </ul>
</div>


      <div class="row footer">

  <hr/>

  <div class="small-6 columns">
    <ul class="inline-list">
      <li><a href="/about">About</a></li>
      <li><a href="/subscribe">Subscribe</a></li>
      <li><a href="/tipjar">Leave a tip</a></li>
    </ul>
  </div>

  <div class="small-6 columns">
    <p class="text-right">
    Vimcasts.org established MMX
    </p>
  </div>

</div>


    </div>
  </div>




      </section>

      <a class="exit-off-canvas"></a>

    </div>
  </div>

  <script src="/javascripts/all.js" type="text/javascript"></script>

  </body>
</html>

