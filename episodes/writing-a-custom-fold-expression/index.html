
<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Writing a custom fold expression</title>

    
      <meta name="st:robots" content="follow, index">
    

    
      <link href="/feeds/ogg" title="Vimcasts OGG Feed" rel="alternate" type="application/rss+xml" />
    
      <link href="/feeds/quicktime" title="Vimcasts Quicktime Feed" rel="alternate" type="application/rss+xml" />
    

    <link href="/stylesheets/app.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/autocomplete.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/syntax.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/modernizr.js" type="text/javascript"></script>
  </head>

  <body class="episodes episodes_writing-a-custom-fold-expression episodes_writing-a-custom-fold-expression_index" data-swiftype-index='false'>

  <div class="off-canvas-wrap">
    <div class="inner-wrap">

      <div class="top-bar-underlay"></div>

      <div class="row">
        <nav class="top-bar show-for-large-up" data-topbar>
          <ul class="title-area">
            <li class="name">
              <h1><a href="/">Vimcasts</a></h1>
            </li>
            <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
          </ul>

          <section class="top-bar-section">

            
              <!-- Right Nav Section -->
              <ul class="right">
                <li class="has-form">
                <div class="row collapse">
                  <div class="large-12 columns">
                    <form class="swiftype-search-form">
  <input type="search" class="swiftype-search-input" placeholder="Search the archives"/>
</form>


                  </div>
                </div>
                </li>
              </ul>
            

            <!-- Left Nav Section -->
            <ul class="left">
              <li class="has-dropdown">
  <a href="/categories">Browse Vimcasts</a>
  <ul class="dropdown">
    <li><a href="/episodes">Latest episodes</a></li>
    <li><a href="/blog">Latest articles</a></li>
  </ul>
</li>
<li><a href="/training">Training</a></li>
<li><a href="/publications">Publications</a></li>


            </ul>
          </section>
        </nav>
      </div>

      <nav class="tab-bar hide-for-large-up">
        <section class="left-small">
          <a class="left-off-canvas-toggle menu-icon" ><span></span></a>
        </section>

        <section class="middle tab-bar-section"></section>
      </nav>

      <aside class="left-off-canvas-menu">
        <ul class="off-canvas-list">
          <li><label>Vimcasts</label></li>
          <li class="has-dropdown">
  <a href="/categories">Browse Vimcasts</a>
  <ul class="dropdown">
    <li><a href="/episodes">Latest episodes</a></li>
    <li><a href="/blog">Latest articles</a></li>
  </ul>
</li>
<li><a href="/training">Training</a></li>
<li><a href="/publications">Publications</a></li>



          
            <li>
              <form class="swiftype-search-form">
  <input type="search" class="swiftype-search-input" placeholder="Search the archives"/>
</form>


            </li>
          
        </ul>
      </aside>

      <section class="main-section">

        <div class="row identity-row">
          <div id="logo" class="small-4 columns">
            <h1>
              
                <a href="/" title="Go to Vimcasts.org homepage">VimCasts.org</a>
              
            </h1>
          </div>
          <div class="small-7 small-offset-1 columns">
            
            <h4 class="text-right">
              Level-up your Vim<br/>
              <small>with Drew Neil, author of <a href="http://pragprog.com/book/dnvim/practical-vim">Practical&nbsp;Vim</a></small>
            </h4>
            
          </div>
        </div>

          <div class="row">
    <div class="small-12 columns">

      

<div class="row announcement-banner">
  <div class="small-12 column show-for-small-only">
    <div class="panel">
      <p>
            No Core Vim Classes are currently scheduled. <a href="#">Sign up to the mailing list</a> to hear of upcoming classes.
</p>

      
    </div>
  </div>

  <div class="panel show-for-medium-up clearfix">
    <div class="small-8 column">
      <p>
            No Core Vim Classes are currently scheduled. <a href="#">Sign up to the mailing list</a> to hear of upcoming classes.
</p>

    </div>

    <div class="small-4 column">
      
    </div>
  </div>

</div>



      <header>
        <h2>Writing a custom fold expression</h2>
        <div class="episode_number">
          <small>#</small>38
        </div>
        <time pubdate="pubdate" datetime="2012-11-26">
          Nov 26, 2012
        </time>
        <div class="video-duration">
          
          Run time: <time datetime="P12M,07S">
            12:07
          </time>
        </div>
        
          <div class="video-tags">
            Tagged with:
            <a href="/categories/folding">folding</a>
          </div>
        
      </header>

      <div data-swiftype-index="true">
        <p>With a little bit of Vimscript, you can create a custom folding expression for any filetype. We&rsquo;ll start by looking at the mechanics of folding with markers, then go on to create a folding expression for markdown documents.</p>


      </div>

      <video poster="http://vimcasts.org/images/posters/custom_foldexpr.png"
        controls="controls" preload="none" class="placeholder"
        id="episode_38_placeholder">
        <source src="http://media.vimcasts.org/videos/38/writing-a-foldexpr.ogv" type="video/ogg" />
        <source src="http://media.vimcasts.org/videos/38/writing-a-foldexpr.m4v" type="video/x-m4v" />
      </video>

      <aside class="downloads">
        <ul class="inline-list">
          <li>Download: </li>

          <li class="ogg">
          <a href="http://media.vimcasts.org/videos/38/writing-a-foldexpr.ogv">OGG</a>
          <span class="stats">18.1 MB</span>
          </li>

          <li class="quicktime">
          <a href="http://media.vimcasts.org/videos/38/writing-a-foldexpr.m4v">Quicktime</a>
          <span class="stats">23.8 MB</span>
          </li>

      </ul>

        <p>
          View a <a href="/transcripts/38/en/">transcript of the video</a>.
        </p>
      </aside>

      <dl class="accordion" data-accordion>
        <dd>
        <a href="#shownotes">Shownotes</a>
        <div id="shownotes" class="content" data-swiftype-index="true">
          

<p>Here&rsquo;s <a href="https://gist.github.com/4149842">a gist of the markdown folding expression</a> that was created in the video. </p>

<h2>Creating an ftplugin</h2>

<p>Create a filetype plugin for markdown files as follows:</p>
<pre class="highlight plaintext">mkdir -p ~/.vim/after/ftplugin/markdown
vim ~/.vim/after/ftplugin/markdown/folding.vim
</pre>

<p>You can replace <code>markdown</code> with the name of any other language to create a filetype plugin for that language instead.</p>

<h2>The mechanics of a <code>foldexpr</code></h2>

<p>Here&rsquo;s the boilerplate fold expression that we used to begin with:</p>
<pre class="highlight viml"><span class="k">function</span><span class="p">!</span> MarkdownFolds<span class="p">()</span>
  <span class="k">return</span> <span class="s2">"0"</span>
<span class="k">endfunction</span>
<span class="k">setlocal</span> foldmethod<span class="p">=</span>expr
<span class="k">setlocal</span> foldexpr<span class="p">=</span>MarkdownFolds<span class="p">()</span>
</pre>

<p>It works like this: the <code>MarkdownFolds()</code> function is called one time <em>for each line</em> in the document. If the function returns <code>&quot;0&quot;</code>, it indicates that the line is not part of a fold. If the function returns <code>&quot;1&quot;</code>, it indicates that the line has a fold level of one. Here are a few more values that can be returned from a fold expression, with their meanings:</p>

<table>
    <tr>
        <th>value</th>
        <th>meaning</th>
    </tr>
    <tr>
        <td><code>"0"</code></td>
        <td>the line is not in a fold</td>
    </tr>
    <tr>
        <td><code>"1", "2", ...</code></td>
        <td>the line is in a fold with this level</td>
    </tr>
    <tr>
        <td><code>"="</code></td>
        <td>use fold level from the previous line</td>
    </tr>
    <tr>
        <td><code>"&gt;1", "&gt;2"</code></td>
        <td>a fold with this level starts at this line</td>
    </tr>
</table>

<p>For a complete list of values that can be returned by a fold expression, look up <a href="http://vimdoc.sourceforge.net/htmldoc/fold.html#fold-expr"><code>:help fold-expr</code></a>.</p>

<p>Inside of a fold expression, we can use the <a href="http://vimdoc.sourceforge.net/htmldoc/eval.html#v:lnum"><code>v:lnum</code></a> variable to access the line number of the current line that is being evaluated. This can easily be combined with the <a href="http://vimdoc.sourceforge.net/htmldoc/eval.html#getline()"><code>getline()</code></a> function to get the <em>contents</em> of the current line that&rsquo;s being evaluated.</p>

<h2>Customizing the <code>foldtext</code></h2>

<p>We can customize the way that a fold looks by way of the <a href="http://vimdoc.sourceforge.net/htmldoc/options.html#&amp;#x27;foldtext&amp;#x27;"><code>foldtext</code></a> option. Here&rsquo;s the boilerplate foldtext expression that we used to begin with:</p>
<pre class="highlight viml"><span class="k">function</span><span class="p">!</span> MarkdownFoldText<span class="p">()</span>
  <span class="k">return</span> getline<span class="p">(</span><span class="k">v</span><span class="p">:</span>foldstart<span class="p">)</span>
<span class="k">endfunction</span>
<span class="k">setlocal</span> foldtext<span class="p">=</span>MarkdownFoldText<span class="p">()</span>
</pre>

<p>Inside of a foldtext expression, we can use the <a href="http://vimdoc.sourceforge.net/htmldoc/eval.html#v:foldstart"><code>v:foldstart</code></a> and <a href="http://vimdoc.sourceforge.net/htmldoc/eval.html#v:foldend"><code>v:foldend</code></a> variables, which reference the line numbers of the first and last lines that make up the current fold.</p>

<h2>Further Reading</h2>

<ul>
<li><a href="http://vimdoc.sourceforge.net/htmldoc/fold.html#fold-expr"><code>:help fold-expr</code></a></li>
<li><a href="http://vimdoc.sourceforge.net/htmldoc/fold.html#fold-marker"><code>:help fold-marker</code></a></li>
<li><a href="http://vimdoc.sourceforge.net/htmldoc/options.html#&amp;#x27;foldcolumn&amp;#x27;"><code>:help foldcolumn</code></a></li>
<li><a href="http://vimdoc.sourceforge.net/htmldoc/fold.html#fold-foldcolumn"><code>:help fold-foldcolumn</code></a></li>
<li><a href="http://vimdoc.sourceforge.net/htmldoc/eval.html#v:lnum"><code>:help v:lnum</code></a></li>
</ul>

<p>In preparing this material, I took inspiration from several sources, including:</p>

<ul>
<li><a href="https://gist.github.com/1038710">gist from Steve Losh</a></li>
<li><a href="http://learnvimscriptthehardway.stevelosh.com/chapters/48.html">Basic folding</a> chapter from Learn Vimscript the Hard Way</li>
<li><a href="http://learnvimscriptthehardway.stevelosh.com/chapters/49.html">Advanced folding</a> chapter from Learn Vimscript the Hard Way</li>
<li><a href="http://stackoverflow.com/questions/3828606/vim-markdown-folding">Vim Markdown Folding?</a> on Stack Overflow</li>
</ul>

        </div>
        </dd>
        <dd>
        <a href="#comments">Comments</a>
        <div id="comments" class="content">
          <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'vimcasts'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


        </div>
        </dd>
      </dl>

      <div>
        <p>
        Like this video? Spread the word!
        TODO: add social sharing buttons here.
        </p>
      </div>


      <div>
  <hr/>
  <h3>Related content</h3>
  <ul class="small-block-grid-1 medium-block-grid-2 large-block-grid-3">

    
    

    
      <li>
        <h4><a href="/categories">Find by category</a></h4>
        <p>Vimcasts contains 65 free screencasts and 45 articles. <a href='/categories'>Browse all content by category</a>.</p>
      </li>
    
      <li>
        <h4><a href="/blog/2014/02/vimcasts-redesign-a-work-in-progress/">Vimcasts redesign: a work in progress</a></h4>
        <p>In the not-too-distant future, you can expect to see a revised design for Vimcasts.org. The most significant enhancements will be the addition of tags, site search, and a responsive design for smaller screens. Hannah Adcock, from <a href="http://contentedstrategy.com">contentedstrategy.com</a>, has been helping me out by analysing user feedback, as well as data from Google Analytics.</p>


      </li>
    
      <li>
        <h4><a href="/episodes/how-to-fold/">How to fold</a></h4>
        <p>Vim&rsquo;s folding feature enables us to expand and collapse regions of a document. Not only does this allow us to organize our workspace, it also makes it easy to navigate around the document, and to rearrange entire sections as though they were single lines.</p>


      </li>
    
      <li>
        <h4><a href="/training">Vim Training</a></h4>
        <p>Boost your productivity with a <a href='/training'>Vim training class</a>. Join a public class, or <a href='/training/private'>book a private session</a> for your team.</p>
      </li>
    
      <li>
        <h4><a href="/episodes/using-external-filter-commands-to-reformat-html/">Using external filter commands to reformat HTML</a></h4>
        <p>We can use pandoc as a <a href="http://vimdoc.sourceforge.net/htmldoc/change.html#filter">filter</a> to clean up <abbr title="what you see is what you get">WYSIWYG</abbr>-generated HTML. Pandoc is a commandline program, but we can call it from inside Vim either using the <a href="http://vimdoc.sourceforge.net/htmldoc/various.html#:!">bang Ex command</a>, or by configuring <a href="http://vimdoc.sourceforge.net/htmldoc/options.html#&amp;#x27;formatprg&amp;#x27;">the <code>formatprg</code> option</a> to make the <code>gq</code> operator invoke pandoc.</p>


      </li>
    
      <li>
        <h4><a href="/publications">Publications</a></h4>
        <p>Make yourself a faster and more efficient developer with the help of <a href='/publications'>these publications</a>.</p>
      </li>
    

  </ul>
</div>


      <div class="row footer">

  <hr/>

  <div class="small-6 columns">
    <ul class="inline-list">
      <li><a href="/about">About</a></li>
      <li><a href="/subscribe">Subscribe</a></li>
      <li><a href="/tipjar">Leave a tip</a></li>
    </ul>
  </div>

  <div class="small-6 columns">
    <p class="text-right">
    Vimcasts.org established MMX
    </p>
  </div>

</div>


    </div>
  </div>




      </section>

      <a class="exit-off-canvas"></a>

    </div>
  </div>

  <script src="/javascripts/all.js" type="text/javascript"></script>

  </body>
</html>

