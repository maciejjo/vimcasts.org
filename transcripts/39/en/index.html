
<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Use title if it's in the page YAML frontmatter -->
    <title></title>

    
      <meta name="st:robots" content="follow, index">
    

    
      <link href="/feeds/ogg.rss" title="Vimcasts OGG Feed" rel="alternate" type="application/rss+xml" />
    
      <link href="/feeds/quicktime.rss" title="Vimcasts Quicktime Feed" rel="alternate" type="application/rss+xml" />
    

    <link href="/stylesheets/vimcasts.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/modernizr.js" type="text/javascript"></script>
  </head>

  <body class="transcripts transcripts_39 transcripts_39_en transcripts_39_en_index" data-swiftype-index='false'>

  <div class="off-canvas-wrap">
    <div class="inner-wrap">

      <div class="top-bar-underlay"></div>

      <div class="row">
        <nav class="top-bar show-for-large-up" data-topbar>
          <ul class="title-area">
            <li class="name"></li>
            <li class="toggle-topbar menu-icon"><a href="#">Menu</a></li>
          </ul>

          <section class="top-bar-section">

            
              <!-- Right Nav Section -->
              <ul class="right search-form-wrapper">
                <li class="has-form">
                <div class="row collapse">
                  <div class="large-12 columns">
                    <form class="swiftype-search-form">
  <input type="search" class="swiftype-search-input" placeholder="Search the archives"/>
</form>


                  </div>
                </div>
                </li>
              </ul>
            

            <!-- Left Nav Section -->
            <ul class="left">
              <li><a href="/episodes">Screencasts</a></li><li><a href="/blog">Articles</a></li><li><a href="/categories">Categories</a></li><li><a href="/training">Training</a></li><li><a href="/publications">Publications</a></li>
<li><a href="/subscribe">Subscribe</a></li>
            </ul>
          </section>
        </nav>

      </div>

      <nav class="compact-nav tab-bar hide-for-large-up">
        <section class="left-small">
          <a class="left-off-canvas-toggle menu-icon" ><span></span></a>
        </section>

        <section class="right tab-bar-section">
          
            <form class="swiftype-search-form">
  <input type="search" class="swiftype-search-input" placeholder="Search the archives"/>
</form>


          
        </section>
      </nav>

      <aside class="left-off-canvas-menu">
        <ul class="off-canvas-list">
          <li><label>Vimcasts</label></li>
          <li><a href="/episodes">Screencasts</a></li><li><a href="/blog">Articles</a></li><li><a href="/categories">Categories</a></li><li><a href="/training">Training</a></li><li><a href="/publications">Publications</a></li>
<li><a href="/subscribe">Subscribe</a></li>

          
            <li>
              <form class="swiftype-search-form">
  <input type="search" class="swiftype-search-input" placeholder="Search the archives"/>
</form>


            </li>
          
        </ul>
      </aside>

      <section class="main-section">

        <div class="identity-row">
          <div id="logo" class="logo">
            <h1>
              
                <a href="/" title="Go to Vimcasts.org homepage">VimCasts.org</a>
              
            </h1>
          </div>
          
            
          
        </div>

          

  <section class="transcript">
    <div class="title-row">
      <h2 class="title">
        Profiling Vimscript performance
      </h2>
      <h2 class="episode_number">
        <small>#</small>39
      </h2>
    </div>

    <div class="pubdate-row">
      <div class="transcript-context">
        This is a transcript of
        <a href="/episodes/profiling-vimscript-performance/">screencast&nbsp;39</a>.
      </div>
      <time class="pubdate" pubdate="pubdate" datetime="2012-12- 3">
        <div class="hide-for-medium-up">Dec&nbsp; 3, '12</div><div class="show-for-medium-up">Dec  3, 2012</div>
      </time>
    </div>

    <div class="summary-row">
      <div class="episode_summary enlarged">
        <p>Vim users are unforgiving of plugins that impair performance. Luckily, Vim provides built-in profiling tools that make it easy to diagnose performance issues. We&rsquo;ll start by looking at how to profile the vimrc file, then move on to a real world scenario where profiling helped to identify and aleviate a performance bottleneck.</p>


      </div>
    </div>

    <div class="transcript-row">
      <div class="transcript-body">
      <h2>Enable profiling on Vim startup</h2>
<pre class="highlight plaintext">:help profiling
</pre>

<p>Vim provides an Ex command for profiling scripts and functions written in Vimscript.</p>

<p>The basic strategy goes like this: we&rsquo;ll begin by calling <code>:profile start</code>, and providing a filename where we&rsquo;d like the results to be written. Then we&rsquo;ll call <code>:profile file</code>, and provide the path of the Vimscript that we&rsquo;d like to analyse.</p>

<p>The simplest way to setup profiling is to do it as Vim launches. Vim provides a couple of commandline flags that allow us run Ex commands at launch:</p>
<pre class="highlight plaintext">$ vim -h | grep \&lt;command\&gt;
--cmd &lt;command&gt; Execute &lt;command&gt; before loading any vimrc file
-c &lt;command&gt;        Execute &lt;command&gt; after loading the first file
</pre>

<p>The <code>--cmd</code> (sea-em-dee) flag allows us to run an Ex command before the vimrc file has even loaded, and the <code>-c</code> (dash-sea) flag allows us to run an Ex command after sourcing the vimrc and loading a buffer. Both of these are going to come in handy.</p>

<p>For starters, let&rsquo;s try profiling my <code>vimrc</code> file.</p>
<pre class="highlight plaintext">vim --cmd 'profile start vimrc.profile' --cmd 'profile! file ~/.vimrc'
</pre>

<p>We&rsquo;ll tell Vim to write the results to a file called <code>vimrc.profile</code>. With a second Ex command, we&rsquo;ll instruct Vim that we want it to profile the <code>vimrc</code> file. When we run this command, Vim launches up as usual. Now let&rsquo;s quit Vim, and we should see that there&rsquo;s a new file: <code>vimrc.profile</code>.</p>

<p>Let&rsquo;s have a look inside. This first block shows the time spent sourcing the script. In the next block, we get a breakdown for each function. At the end of the file, we get a summary of functions, sorted by execution time.</p>

<p>Well, there&rsquo;s nothing to see at the moment! These functions have been loaded into memory, but none have been executed. Let&rsquo;s try that again, but this time I&rsquo;ll tell Vim to execute the <code>Zzzz()</code> function after loading the first file:</p>
<pre class="highlight plaintext">vim --cmd 'profile start vimrc.profile' --cmd 'profile! file ~/.vimrc' -c 'call Zzzz()'
</pre>

<p>Remember, the <code>--cmd</code> commands are run before the vimrc loads, while the <code>-c</code> commands are run after the first buffer is loaded. Run that, [&hellip;wait a bit&hellip;]  quit Vim, and let&rsquo;s have another look at the profile data.</p>

<p>This time, the function summary shows that the <code>Zzzz()</code> method has been called once. The &ldquo;Total&rdquo; time is the time passed while the function was executing. The &ldquo;Self&rdquo; time is the &ldquo;Total&rdquo; time reduced by time spent in: other user defined functions, sourced scripts, and external shell commands.</p>

<p>If we take a look at the <code>Zzzz()</code> function in my vimrc, you&rsquo;ll see at once why it&rsquo;s taking so long to run!</p>

<h2>Real world example</h2>

<p>If you were following along in the last episode, you might have spotted a flaw in the implementation of the markdown-folding script. This sample document should demonstrate:</p>
<pre class="highlight plaintext"># Minimal C++ program

Here is a minimal C++ program which prints "Hello world!":

```cpp
#include &lt;iostream&gt;
void main()
{
  std::cout &lt;&lt; "Hello world!";
}
```
</pre>

<p>If a line begins with a hash symbol inside of a fenced code block, it should not create a new fold.</p>

<p>[Get the snapshot: g co c450f7f50cc73253c9f8186b7221bb1c4508772e]</p>

<p>Let me demonstrate my first attempt at solving this issue. If I open up the sample document, you should see that the folding expression now ignores lines inside of the fenced code block. You won&rsquo;t observe any problems with a small file such as this, but watch what happens if I open a longer markdown file:</p>
<pre class="highlight plaintext">vim test/profiling/1.5_kilos.md
</pre>

<p>It takes a few seconds to load. And while we&rsquo;re waiting, note that Vim is maxing out one of my processors! That won&rsquo;t do at all.</p>

<p>Let&rsquo;s profile the folding script and see if we can locate the bottleneck.</p>

<p>Here, I&rsquo;ve created a bash script that sets up profiling and launches Vim with the 1500 line markdown file. Note that it analyses the <code>markdown/folding.vim</code> script, and saves the results to a file at the path specified here.</p>
<pre class="highlight plaintext">vim --cmd 'profile start MarkdownFolding-file.result' \
    --cmd 'profile! file *markdown/folding.vim' \
    -c 'profdel file *markdown/folding.vim' \
    1.5_kilos.md
</pre>

<p>I&rsquo;ll save that file, and make it executable.</p>
<pre class="highlight plaintext">chmod +x MarkdownFolding-file.runner
</pre>

<p>Now we can profile the script just by running (dot-slash and the name of the script):</p>
<pre class="highlight plaintext">./MarkdownFolding-file.runner
</pre>

<p>That launches Vim with profiling enabled. As before, we&rsquo;re seeing a delay of several seconds before the buffer opens. Now we&rsquo;ll quit Vim, and open up the results file:</p>
<pre class="highlight plaintext">vim MarkdownFolding-file.result
</pre>

<p>If we skip to the summary at the end, it&rsquo;s immediately obvious where the bottleneck is: this function called <code>IsFenced()</code> is taking about 5 seconds to run.</p>

<p>Let&rsquo;s find the detailed breakdown of the <code>IsFenced()</code> function. We get the total number of calls, and the time spent executing this function. But we also get a breakdown of the time spent executing each line within the function.  Clearly, this call to the <code>searchpairpos</code> function is quite expensive. It doesn&rsquo;t help that it&rsquo;s being called over 1500 times!</p>

<h2>2nd attempt</h2>

<p>If we look at the code, there&rsquo;s a really simple optimization that we can make. This <code>HeadingDepth()</code> function is called once for every line in the file. At the moment, it checks every single line to see if it&rsquo;s part of a fenced code block. But we only actually care about that if the line in question looks like a markdown heading.</p>

<p>Let&rsquo;s move the <code>IsFenced()</code> test down here, so that it only runs if the current line starts with a hash symbol. We&rsquo;ll save that change, then run the profiling script again:</p>
<pre class="highlight plaintext">./MarkdownFolding-file.runner
</pre>

<p>Straight away, it&rsquo;s clear that things are running faster. We&rsquo;ll quit Vim, then open up the results file. Recall that the previous benchmark took about 5 seconds. This small change has cut it down to just over a second. That&rsquo;s a big improvement, but it&rsquo;s still not good enough.</p>

<h2>3rd attempt</h2>

<p>The <code>searchpairpos()</code> function works by looking forward and backward from the current cursor position for an opening pattern and a closing pattern. It does the job, but as we&rsquo;ve seen, it&rsquo;s expensive to run.</p>

<p>My next idea was to simply look at the syntax highlighting for the current line, and check if it used the syntax group <code>markdownCode</code>. I can quickly demonstrate by running this expression:</p>
<pre class="highlight plaintext">:echo map(synstack(line('.'), col('.')), 'synIDattr(v:val, "name")')
</pre>

<p>If I place my cursor on a header and run this, it outputs <code>markdownH1</code>. If I place my cursor on a codeblock and run the same command, it outputs <code>markdownCode</code>. Let&rsquo;s throw out this expensive algorithm, and replace it with a simple syntax check.</p>

<p>Save the change, then run the profiling script again:</p>
<pre class="highlight plaintext">./MarkdownFolding-file.runner
</pre>

<p>Bang! That was quick!</p>

<p>Let&rsquo;s have a look at the results. Now the <code>IsFenced()</code> function is completing in about 100 milliseconds. That&rsquo;s down from about 1 second when we used the <code>searchpairpos()</code> function. So we&rsquo;ve made another massive gain. I&rsquo;m happy to call that good enough for now.</p>

<h2>Outro</h2>

<p>Thanks to Sergey Alexandrov for raising this issue on github. I learned a lot by working through it, and I hope this demonstration will inspire other plugin authors to work through any performance issues.</p>

      </div>
    </div>

  </section>

  <div class="row">
    <div class="small-12 columns">
      <div class="row footer">

  <hr/>

  <div class="small-6 columns">
    <ul class="inline-list">
      <li><a href="/about">About</a></li>
      <li><a href="/subscribe">Subscribe</a></li>
      <li><a href="/tipjar">Leave a tip</a></li>
    </ul>
  </div>

  <div class="small-6 columns">
    <p class="text-right">
    Vimcasts.org established MMX
    </p>
  </div>

</div>

    </div>
  </div>

  


      </section>

      <a class="exit-off-canvas"></a>

    </div>
  </div>

  <script src="/javascripts/all.js" type="text/javascript"></script>

  

  </body>
</html>
